<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Estaci√≥n Meteorol√≥gica</title>
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      color: #e2e8f0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      text-align: center;
      margin-bottom: 40px;
      padding-top: 20px;
    }

    .header h1 {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 10px;
      background: linear-gradient(135deg, #60a5fa 0%, #f97316 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .status {
      display: inline-block;
      padding: 8px 16px;
      background: rgba(34, 197, 94, 0.2);
      border: 1px solid #22c55e;
      border-radius: 20px;
      font-size: 0.875rem;
      color: #86efac;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .card {
      background: rgba(30, 41, 59, 0.8);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 12px;
      padding: 24px;
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .card:hover {
      border-color: rgba(148, 163, 184, 0.4);
      transform: translateY(-5px);
      box-shadow: 0 12px 48px rgba(0, 0, 0, 0.5);
    }

    .card-title {
      font-size: 0.875rem;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 12px;
    }

    .card-value {
      font-size: 2.5rem;
      font-weight: 700;
      color: #f1f5f9;
      margin-bottom: 8px;
    }

    .card-unit {
      font-size: 1rem;
      color: #64748b;
    }

    .card.temp .card-value {
      background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .card.humidity .card-value {
      background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .card.pressure .card-value {
      background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .card.light .card-value {
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .chart-container {
      background: rgba(30, 41, 59, 0.8);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 12px;
      padding: 24px;
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      margin-bottom: 30px;
    }

    .chart-title {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 20px;
      color: #f1f5f9;
    }

    .footer {
      text-align: center;
      padding: 20px;
      color: #64748b;
      font-size: 0.875rem;
    }

    .timestamp {
      color: #94a3b8;
      font-size: 0.875rem;
      margin-top: 12px;
    }

    .spinner {
      display: inline-block;
      width: 8px;
      height: 8px;
      background: #22c55e;
      border-radius: 50%;
      margin-right: 8px;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    @media (max-width: 768px) {
      .header h1 {
        font-size: 1.75rem;
      }

      .grid {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      }

      .card-value {
        font-size: 2rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üå§Ô∏è Estaci√≥n Meteorol√≥gica</h1>
      <p class="status"><span class="spinner"></span>En l√≠nea</p>
    </div>

    <div class="grid">
      <div class="card temp">
        <div class="card-title">Temperatura</div>
        <div class="card-value"><span id="temp">--</span><span class="card-unit">¬∞C</span></div>
        <div class="timestamp">√öltima actualizaci√≥n: <span id="time">--:--</span></div>
      </div>

      <div class="card humidity">
        <div class="card-title">Humedad</div>
        <div class="card-value"><span id="humidity">--</span><span class="card-unit">%</span></div>
        <div class="timestamp">√öltima actualizaci√≥n: <span id="time2">--:--</span></div>
      </div>

      <div class="card pressure">
        <div class="card-title">Presi√≥n</div>
        <div class="card-value"><span id="pressure">--</span><span class="card-unit">hPa</span></div>
        <div class="timestamp">√öltima actualizaci√≥n: <span id="time3">--:--</span></div>
      </div>

      <div class="card light">
        <div class="card-title">Luz</div>
        <div class="card-value"><span id="light">--</span><span class="card-unit">%</span></div>
        <div class="timestamp">√öltima actualizaci√≥n: <span id="time4">--:--</span></div>
      </div>
    </div>

    <div class="chart-container">
      <div class="chart-title">üìà Temperatura (√∫ltimas 100 lecturas)</div>
      <canvas id="tempChart"></canvas>
    </div>

    <div class="chart-container">
      <div class="chart-title">üíß Humedad (√∫ltimas 100 lecturas)</div>
      <canvas id="humidityChart"></canvas>
    </div>

    <div class="chart-container">
      <div class="chart-title">üîµ Presi√≥n (√∫ltimas 100 lecturas)</div>
      <canvas id="pressureChart"></canvas>
    </div>

    <div class="footer">
      <p>Mini Estaci√≥n Meteorol√≥gica ‚Ä¢ Arduino UNO R4 WiFi ‚Ä¢ Proyecto Escolar IVD</p>
    </div>
  </div>

  <script>
    // Conectar a Socket.io
    const socket = io();

    // Variables para los gr√°ficos
    let tempChart, humidityChart, pressureChart;
    const maxDataPoints = 100;
    let chartData = {
      labels: [],
      temperature: [],
      humidity: [],
      pressure: []
    };

    // Inicializar gr√°ficos
    function initCharts() {
      const chartOptions = {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: {
            labels: { color: '#e2e8f0' }
          }
        },
        scales: {
          y: {
            ticks: { color: '#64748b' },
            grid: { color: 'rgba(148, 163, 184, 0.1)' }
          },
          x: {
            ticks: { color: '#64748b' },
            grid: { color: 'rgba(148, 163, 184, 0.1)' }
          }
        }
      };

      const tempCtx = document.getElementById('tempChart').getContext('2d');
      tempChart = new Chart(tempCtx, {
        type: 'line',
        data: {
          labels: chartData.labels,
          datasets: [{
            label: 'Temperatura (¬∞C)',
            data: chartData.temperature,
            borderColor: '#60a5fa',
            backgroundColor: 'rgba(96, 165, 250, 0.1)',
            borderWidth: 2,
            tension: 0.3,
            fill: true,
            pointRadius: 3,
            pointBackgroundColor: '#60a5fa'
          }]
        },
        options: chartOptions
      });

      const humCtx = document.getElementById('humidityChart').getContext('2d');
      humidityChart = new Chart(humCtx, {
        type: 'line',
        data: {
          labels: chartData.labels,
          datasets: [{
            label: 'Humedad (%)',
            data: chartData.humidity,
            borderColor: '#06b6d4',
            backgroundColor: 'rgba(6, 182, 212, 0.1)',
            borderWidth: 2,
            tension: 0.3,
            fill: true,
            pointRadius: 3,
            pointBackgroundColor: '#06b6d4'
          }]
        },
        options: chartOptions
      });

      const presCtx = document.getElementById('pressureChart').getContext('2d');
      pressureChart = new Chart(presCtx, {
        type: 'line',
        data: {
          labels: chartData.labels,
          datasets: [{
            label: 'Presi√≥n (hPa)', 
            data: chartData.pressure,
            borderColor: '#f97316',
            backgroundColor: 'rgba(249, 115, 22, 0.1)',
            borderWidth: 2,
            tension: 0.3,
            fill: true,
            pointRadius: 3,
            pointBackgroundColor: '#f97316'
          }]
        },
        options: chartOptions
      });
    }

    // Actualizar datos en UI
    function updateUI(data) {
      document.getElementById('temp').textContent = data.temperature.toFixed(1);
      document.getElementById('humidity').textContent = data.humidity.toFixed(1);
      document.getElementById('pressure').textContent = data.pressure.toFixed(1);
      document.getElementById('light').textContent = Math.min(100, Math.round((data.light / 1023) * 100));

      const time = new Date(data.timestamp).toLocaleTimeString('es-ES');
      document.getElementById('time').textContent = time;
      document.getElementById('time2').textContent = time;
      document.getElementById('time3').textContent = time;
      document.getElementById('time4').textContent = time;
    }

    // Agregar punto al gr√°fico
    function addDataPoint(data) {
      const timestamp = new Date(data.timestamp);
      const label = timestamp.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });

      chartData.labels.push(label);
      chartData.temperature.push(data.temperature);
      chartData.humidity.push(data.humidity);
      chartData.pressure.push(data.pressure);

      // Mantener solo los √∫ltimos N puntos
      if (chartData.labels.length > maxDataPoints) {
        chartData.labels.shift();
        chartData.temperature.shift();
        chartData.humidity.shift();
        chartData.pressure.shift();
      }

      // Actualizar gr√°ficos
      tempChart.data.labels = chartData.labels;
      tempChart.data.datasets[0].data = chartData.temperature;
      tempChart.update('none');

      humidityChart.data.labels = chartData.labels;
      humidityChart.data.datasets[0].data = chartData.humidity;
      humidityChart.update('none');

      pressureChart.data.labels = chartData.labels;
      pressureChart.data.datasets[0].data = chartData.pressure;
      pressureChart.update('none');
    }

    // Cargar historial al conectar
    async function loadHistory() {
      try {
        const response = await fetch('/api/history');
        const data = await response.json();

        data.forEach(reading => {
          addDataPoint({
            temperature: reading.temperature,
            humidity: reading.humidity,
            pressure: reading.pressure,
            timestamp: reading.timestamp
          });
        });
      } catch (error) {
        console.error('Error cargando historial:', error);
      }
    }

    // Socket.io listeners
    socket.on('connect', () => {
      console.log('Conectado al servidor');
    });

    socket.on('currentData', (data) => {
      updateUI(data);
    });

    socket.on('newReading', (data) => {
      updateUI(data);
      addDataPoint(data);
    });

    socket.on('disconnect', () => {
      console.log('Desconectado del servidor');
    });

    // Inicializar al cargar
    window.addEventListener('load', () => {
      initCharts();
      loadHistory();
    });
  </script>
</body>
</html>
